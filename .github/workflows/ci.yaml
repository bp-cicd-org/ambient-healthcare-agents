# =============================================================================
# Ambient Healthcare Agents CI
# =============================================================================
#
# IMPORTANT: This workflow does NOT execute notebooks via nbclient.
# Instead, it directly deploys services using docker compose commands
# based on the deployment steps documented in the notebooks.
#
# Reason: The notebooks contain interactive elements (input(), manual file
# editing) and environment-specific commands (systemctl, /ephemeral paths)
# that are incompatible with CI execution.
#
# Deployment approach:
#   1. Configure environment files (vars.env, ace_controller.env) via sed
#   2. Deploy services directly using docker compose
#   3. Wait for services to be ready
#   4. Run pytest UI tests
#
# Required Secrets:
#   - NGC_API_KEY          : NVIDIA NGC API Key for container registry access
#   - NVIDIA_API_KEY       : NVIDIA API Key for hosted NIM services
#   - SMTP_USERNAME        : Gmail address for sending notification emails
#   - SMTP_PASSWORD        : Gmail app-specific password for SMTP
#
# pytest markers:
#   - ambient-provider: ambient_provider and ui
#   - ambient-patient:  ambient_patient_agent and ui
#   - ambient-patient:  ambient_patient_voice and ui
#
# =============================================================================

name: Ambient Healthcare Agents CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_ambient_provider:
        description: 'Run Ambient Provider tests'
        required: false
        default: true
        type: boolean
      run_ambient_patient:
        description: 'Run Ambient Patient tests'
        required: false
        default: true
        type: boolean

env:
  TEST_IMAGE: nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest
  ENABLE_EMAIL_NOTIFICATION: false

jobs:
  # ============================================
  # PREFLIGHT: Check all prerequisites
  # ============================================
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    outputs:
      preflight_passed: ${{ steps.preflight.outputs.passed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Preflight Checks
        id: preflight
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        run: |
          echo "========================================"
          echo "  PREFLIGHT CHECKS"
          echo "========================================"
          
          FAILED=0
          
          # Check 1: NGC API Key
          if [ -z "${NGC_API_KEY}" ]; then
            echo "✗ ERROR: NGC_API_KEY is not set"
            FAILED=1
          else
            echo "✓ NGC_API_KEY is set"
          fi
          
          # Check 2: NVIDIA API Key
          if [ -z "${NVIDIA_API_KEY}" ]; then
            echo "✗ ERROR: NVIDIA_API_KEY is not set"
            FAILED=1
          else
            echo "✓ NVIDIA_API_KEY is set"
          fi
          
          # Check 3: Test Image can be pulled
          echo "Pulling test image: ${{ env.TEST_IMAGE }}"
          if docker pull ${{ env.TEST_IMAGE }}; then
            echo "✓ Test image pulled successfully"
          else
            echo "✗ ERROR: Cannot pull test image"
            FAILED=1
          fi
          
          # Check 4: Submodules
          if [ -d "ambient-provider" ] && [ "$(ls -A ambient-provider 2>/dev/null)" ]; then
            echo "✓ ambient-provider submodule is initialized"
          else
            echo "✗ ERROR: ambient-provider submodule not initialized"
            FAILED=1
          fi
          if [ -d "ambient-patient" ] && [ "$(ls -A ambient-patient 2>/dev/null)" ]; then
            echo "✓ ambient-patient submodule is initialized"
          else
            echo "✗ ERROR: ambient-patient submodule not initialized"
            FAILED=1
          fi
          
          # Final result
          if [ $FAILED -eq 0 ]; then
            echo "✓ ALL PREFLIGHT CHECKS PASSED"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "✗ PREFLIGHT CHECKS FAILED"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  # ============================================
  # AMBIENT PROVIDER: Deploy & Test
  # ============================================
  ambient-provider:
    name: Ambient Provider - Deploy & Test
    needs: preflight
    if: ${{ needs.preflight.outputs.preflight_passed == 'true' && (github.event_name != 'workflow_dispatch' || inputs.run_ambient_provider) }}
    runs-on: arc-runner-set-oke-org-poc-4-gpu
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Environment
        run: |
          echo "========================================"
          echo "  AMBIENT PROVIDER - ENVIRONMENT SETUP"
          echo "========================================"
          echo "Runner: $(hostname)"
          echo "Docker: $(docker --version)"
          nvidia-smi --query-gpu=index,name,memory.total --format=csv,noheader || echo "nvidia-smi not available"

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Pull Test Image
        run: |
          docker pull ${{ env.TEST_IMAGE }}
          echo "✓ Test image pulled successfully"

      # ==========================================
      # PHASE 1: Configure Environment Files
      # ==========================================
      - name: Configure Environment Files
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "Configuring environment files..."
          
          # Create directory if needed
          mkdir -p ambient-provider/ambient-scribe/apps/api
          
          # Create or update .env file
          echo "NVIDIA_API_KEY=${NVIDIA_API_KEY}" > ambient-provider/ambient-scribe/apps/api/.env
          echo "NGC_API_KEY=${NGC_API_KEY}" >> ambient-provider/ambient-scribe/apps/api/.env
          echo "RIVA_URI=parakeet-nim:50051" >> ambient-provider/ambient-scribe/apps/api/.env
          
          echo "✓ Environment files configured"

      # ==========================================
      # PHASE 2: Install Dependencies & Bootstrap
      # ==========================================
      - name: Install System Dependencies
        run: |
          # Install uv package manager
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.local/bin:$PATH"
          
          # Install portaudio
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev
          
          # Install Node.js 20
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "✓ System dependencies installed"

      - name: Setup Python Environment
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          cd ambient-provider
          uv python install 3.13
          uv python pin 3.13
          uv venv --clear
          uv sync
          echo "✓ Python environment ready"

      - name: Bootstrap Ambient Scribe
        run: |
          cd ambient-provider/ambient-scribe
          make bootstrap
          echo "✓ Bootstrap completed"

      # ==========================================
      # PHASE 3: Deploy Services
      # ==========================================
      - name: Deploy Services with NIM
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        run: |
          echo "========================================"
          echo "  DEPLOYING AMBIENT PROVIDER SERVICES"
          echo "========================================"
          
          cd ambient-provider/ambient-scribe
          
          # Deploy with local NIM (Riva + LLM)
          make dev-nim
          
          echo "Waiting for NIMs to be ready..."
          sleep 60
          
          # Deploy the UI
          make dev
          
          echo "✓ Services deployed"

      - name: Wait for Services Ready
        run: |
          echo "========================================"
          echo "  WAITING FOR SERVICES TO BE READY"
          echo "========================================"
          
          MAX_ATTEMPTS=90
          ATTEMPT=0
          
          # Wait for UI (port 5173)
          echo "Checking UI service (http://localhost:5173)..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -sf -o /dev/null http://localhost:5173 2>/dev/null; then
              echo "✓ UI is ready (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  Waiting... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "⚠ WARNING: UI service timeout"
            docker ps -a --format "table {{.Names}}\t{{.Status}}"
          fi
          
          echo ""
          echo "Docker containers status:"
          docker ps -a --format "table {{.Names}}\t{{.Status}}"

      # ==========================================
      # PHASE 4: Run pytest UI Tests
      # ==========================================
      - name: Run UI Tests - Ambient Provider
        id: pytest
        run: |
          echo "========================================"
          echo "  RUNNING PYTEST: ambient_provider UI"
          echo "========================================"
          
          COMMIT_SHA=$(git rev-parse --short=7 HEAD)
          REPORT_FILE="ambient_provider_${COMMIT_SHA}_test_report.html"
          
          mkdir -p test_reports
          
          docker run --rm \
            --network host \
            -v "$(pwd)/test_reports:/app/reports" \
            ${{ env.TEST_IMAGE }} \
            pytest -m "ambient_provider and ui" \
              --ambient-provider-playground-url="http://localhost:5173" \
              --api-url="http://localhost:8000" \
              --disable-warnings \
              --self-contained-html \
              --html=/app/reports/${REPORT_FILE}
          
          echo "Test report saved to: test_reports/${REPORT_FILE}"

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ambient-provider-test-report
          path: test_reports/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping all containers..."
          cd ambient-provider/ambient-scribe && make down 2>/dev/null || true
          docker stop $(docker ps -aq) 2>/dev/null || true
          echo "✓ Cleanup completed"

  # ============================================
  # AMBIENT PATIENT: Deploy & Test
  # ============================================
  ambient-patient:
    name: Ambient Patient - Deploy & Test
    needs: preflight
    if: ${{ needs.preflight.outputs.preflight_passed == 'true' && (github.event_name != 'workflow_dispatch' || inputs.run_ambient_patient) }}
    runs-on: arc-runner-set-oke-org-poc-4-gpu
    timeout-minutes: 240
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Environment
        run: |
          echo "========================================"
          echo "  AMBIENT PATIENT - ENVIRONMENT SETUP"
          echo "========================================"
          echo "Runner: $(hostname)"
          echo "Docker: $(docker --version)"
          nvidia-smi --query-gpu=index,name,memory.total --format=csv,noheader || echo "nvidia-smi not available"

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Pull Test Image
        run: |
          docker pull ${{ env.TEST_IMAGE }}
          echo "✓ Test image pulled successfully"

      # ==========================================
      # PHASE 1: Configure Environment Files
      # ==========================================
      - name: Configure Environment Files
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "Configuring environment files..."
          cd ambient-patient
          
          # Update agent/vars.env
          sed -i "s|^NGC_API_KEY=.*|NGC_API_KEY=${NGC_API_KEY}|g" agent/vars.env
          sed -i "s|^NVIDIA_API_KEY=.*|NVIDIA_API_KEY=${NVIDIA_API_KEY}|g" agent/vars.env
          
          # Update ace-controller-voice-interface/ace_controller.env
          sed -i "s|^NGC_API_KEY=.*|NGC_API_KEY=${NGC_API_KEY}|g" ace-controller-voice-interface/ace_controller.env
          sed -i "s|^NVIDIA_API_KEY=.*|NVIDIA_API_KEY=${NVIDIA_API_KEY}|g" ace-controller-voice-interface/ace_controller.env
          
          echo "--- agent/vars.env ---"
          cat agent/vars.env | sed 's/nvapi-.*/nvapi-***/g'
          echo ""
          echo "--- ace-controller-voice-interface/ace_controller.env ---"
          cat ace-controller-voice-interface/ace_controller.env | sed 's/nvapi-.*/nvapi-***/g'
          echo ""
          echo "✓ Environment files configured"

      # ==========================================
      # PHASE 2: Deploy Services
      # ==========================================
      - name: Check Available GPUs
        run: |
          echo "========================================"
          echo "  CHECKING AVAILABLE GPUS"
          echo "========================================"
          nvidia-smi --query-gpu=index,name,memory.total --format=csv
          GPU_COUNT=$(nvidia-smi --query-gpu=index --format=csv,noheader | wc -l)
          echo "Total GPUs available: $GPU_COUNT"

      - name: Deploy Agent LLM NIM
        run: |
          echo "========================================"
          echo "  DEPLOYING AGENT LLM NIM"
          echo "========================================"
          cd ambient-patient
          
          # Set GPU IDs for llama-3.3-70b-instruct
          # Using GPUs 0,1 for the LLM (adjust based on available GPUs)
          export AGENT_LLM_GPU_ID="0,1"
          
          docker compose -f agent/docker-compose.yaml up -d agent-instruct-llm
          
          echo "✓ Agent LLM NIM deployment started"
          echo "Waiting for container to start..."
          sleep 30
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: Deploy NemoGuard NIMs
        run: |
          echo "========================================"
          echo "  DEPLOYING NEMOGUARD NIMS"
          echo "========================================"
          cd ambient-patient
          
          # Set GPU IDs for NemoGuard NIMs
          # Using GPUs 2 and 3 (adjust based on available GPUs)
          export NEMOGUARD_CONTENT_SAFETY_LLM_GPU_ID="2"
          export NEMOGUARD_TOPIC_CONTRIL_LLM_GPU_ID="3"
          
          docker compose -f agent/docker-compose.yaml up -d nemoguard-content-safety-llm nemoguard-topic-control-llm
          
          echo "✓ NemoGuard NIMs deployment started"
          sleep 30
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: Deploy App Server
        run: |
          echo "========================================"
          echo "  DEPLOYING APP SERVER"
          echo "========================================"
          cd ambient-patient
          
          docker compose -f agent/docker-compose.yaml up --build -d app-server
          
          echo "✓ App server deployment started"
          sleep 30
          docker ps --format "table {{.Names}}\t{{.Status}}"

      - name: Deploy Turn Server
        run: |
          echo "========================================"
          echo "  DEPLOYING TURN SERVER"
          echo "========================================"
          
          # Get external IP
          HOST_IP_EXTERNAL=$(curl -sf https://ifconfig.me || echo "127.0.0.1")
          echo "External IP: $HOST_IP_EXTERNAL"
          
          # Run Turn server
          docker run -d --name turn-server --network=host instrumentisto/coturn \
            -n --verbose --log-file=stdout \
            --external-ip=$HOST_IP_EXTERNAL \
            --listening-ip=0.0.0.0 \
            --lt-cred-mech --fingerprint \
            --user=admin:admin \
            --no-multicast-peers \
            --realm=tokkio.realm.org \
            --min-port=51000 --max-port=51010
          
          echo "✓ Turn server deployed"
          
          # Update ace_controller.env with Turn server config
          cd ambient-patient
          echo -e "\nTURN_USERNAME=admin\nTURN_PASSWORD=admin\nTURN_SERVER_URL=turn:$HOST_IP_EXTERNAL:3478" >> ace-controller-voice-interface/ace_controller.env
          
          # Update config.ts with ICE server
          sed -i "s/export const RTC_CONFIG = {};/export const RTC_CONFIG: ConstructorParameters<typeof RTCPeerConnection>[0] = { iceServers: [{ urls: \"turn:$HOST_IP_EXTERNAL:3478\", username: \"admin\", credential: \"admin\" }] };/" ace-controller-voice-interface/config.ts
          
          echo "✓ Turn server configuration updated"

      - name: Deploy ACE Controller Voice UI
        run: |
          echo "========================================"
          echo "  DEPLOYING ACE CONTROLLER VOICE UI"
          echo "========================================"
          cd ambient-patient
          
          docker compose --profile ace-controller -f ace-controller-voice-interface/docker-compose.yml up --build -d
          
          echo "✓ ACE Controller Voice UI deployment started"

      - name: Wait for Services Ready
        run: |
          echo "========================================"
          echo "  WAITING FOR SERVICES TO BE READY"
          echo "========================================"
          
          MAX_ATTEMPTS=180
          ATTEMPT=0
          
          # Wait for Agent LLM to be healthy
          echo "Checking Agent LLM health..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' agent-instruct-llm 2>/dev/null || echo "unknown")
            if [ "$STATUS" = "healthy" ]; then
              echo "✓ Agent LLM is healthy (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  LLM Status: $STATUS ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          # Wait for App Server API (port 8081)
          ATTEMPT=0
          echo "Checking App Server API (http://localhost:8081)..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -sf -o /dev/null http://localhost:8081/health 2>/dev/null || curl -sf -o /dev/null http://localhost:8081/ 2>/dev/null; then
              echo "✓ App Server is ready (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  Waiting... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          # Wait for Voice UI (port 4400)
          ATTEMPT=0
          echo "Checking Voice UI service (http://localhost:4400)..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -sf -o /dev/null http://localhost:4400 2>/dev/null; then
              echo "✓ Voice UI is ready (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  Waiting... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          echo ""
          echo "Final container status:"
          docker ps -a --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"

      # ==========================================
      # PHASE 3: Run pytest UI Tests
      # ==========================================
      - name: Run UI Tests - Ambient Patient Agent
        id: pytest_agent
        run: |
          echo "========================================"
          echo "  RUNNING PYTEST: ambient_patient_agent UI"
          echo "========================================"
          
          COMMIT_SHA=$(git rev-parse --short=7 HEAD)
          REPORT_FILE="ambient_patient_agent_${COMMIT_SHA}_test_report.html"
          
          mkdir -p test_reports
          
          docker run --rm \
            --network host \
            -v "$(pwd)/test_reports:/app/reports" \
            ${{ env.TEST_IMAGE }} \
            pytest -m "ambient_patient_agent and ui" \
              --ambient-agent-ui-url="http://localhost:8081" \
              --disable-warnings \
              --self-contained-html \
              --html=/app/reports/${REPORT_FILE}
          
          echo "Test report saved to: test_reports/${REPORT_FILE}"

      - name: Run UI Tests - Ambient Patient Voice
        id: pytest_voice
        run: |
          echo "========================================"
          echo "  RUNNING PYTEST: ambient_patient_voice UI"
          echo "========================================"
          
          COMMIT_SHA=$(git rev-parse --short=7 HEAD)
          REPORT_FILE="ambient_patient_voice_${COMMIT_SHA}_test_report.html"
          
          mkdir -p test_reports
          
          docker run --rm \
            --network host \
            -v "$(pwd)/test_reports:/app/reports" \
            ${{ env.TEST_IMAGE }} \
            pytest -m "ambient_patient_voice and ui" \
              --ambient-patient-voice-ui-url="http://localhost:4400" \
              --disable-warnings \
              --self-contained-html \
              --html=/app/reports/${REPORT_FILE}
          
          echo "Test report saved to: test_reports/${REPORT_FILE}"

      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ambient-patient-test-reports
          path: test_reports/
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping all containers..."
          cd ambient-patient
          docker compose -f agent/docker-compose.yaml down 2>/dev/null || true
          docker compose --profile ace-controller -f ace-controller-voice-interface/docker-compose.yml down 2>/dev/null || true
          docker stop turn-server 2>/dev/null || true
          docker stop $(docker ps -aq) 2>/dev/null || true
          echo "✓ Cleanup completed"

  # ============================================
  # SUMMARY: Generate final report
  # ============================================
  summary:
    name: Generate Summary
    needs: [preflight, ambient-provider, ambient-patient]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Generate Summary Report
        run: |
          echo "# Ambient Healthcare Agents CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Preflight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ambient Provider | ${{ needs.ambient-provider.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ambient Patient | ${{ needs.ambient-patient.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Set Result Output
        id: set_result
        if: always()
        run: |
          PREFLIGHT="${{ needs.preflight.result }}"
          PROVIDER="${{ needs.ambient-provider.result }}"
          PATIENT="${{ needs.ambient-patient.result }}"
          
          if [ "$PREFLIGHT" == "success" ] && \
             ([ "$PROVIDER" == "success" ] || [ "$PROVIDER" == "skipped" ]) && \
             ([ "$PATIENT" == "success" ] || [ "$PATIENT" == "skipped" ]); then
            echo "RESULT=PASS" >> $GITHUB_OUTPUT
          else
            echo "RESULT=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@6e71c855c9a091d80a519621b9fd3e8d252ca40c
        if: always() && env.ENABLE_EMAIL_NOTIFICATION == 'true'
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI Result: Ambient Healthcare Agents - ${{ steps.set_result.outputs.RESULT }}"
          to: Github-Action-Blueprint-QA@nvidia.com
          from: github-workflow-notification@gmail.com
          html_body: |
            <h2>Ambient Healthcare Agents CI Notification</h2>
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
            <p><strong>Result:</strong> ${{ steps.set_result.outputs.RESULT }}</p>
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Run</a></p>
